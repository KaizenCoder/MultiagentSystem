#!/usr/bin/env python3
"""
ğŸ¯ TRANSFORMATION CANDIDAT CHOISI - AGENT 11 AUDITEUR QUALITÃ‰
Transformation complÃ¨te avec toutes les sÃ©curitÃ©s automatiques
"""
import asyncio
import sys
from pathlib import Path
from datetime import datetime
import logging

# Configuration
CANDIDAT_CHOISI = "agent_11_auditeur_qualite.py"
AGENTS_DIR = Path("C:/Dev/nextgeneration/agent_factory_implementation/agents")
BACKUPS_DIR = Path("C:/Dev/nextgeneration/agent_factory_implementation/backups")
REPORTS_DIR = Path("C:/Dev/nextgeneration/agent_factory_implementation/agents/reviews")

class TransformationCandidatChoisi:
    def __init__(self):
        self.setup_logging()
        
    def setup_logging(self):
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(levelname)s - %(message)s',
            handlers=[
                logging.FileHandler(f'logs/transformation_candidat_{datetime.now().strftime("%Y%m%d_%H%M%S")}.log'),
                logging.StreamHandler(sys.stdout)
            ]
        )
        self.logger = logging.getLogger(__name__)

    async def lancer_transformation_complete(self):
        """Lance la transformation complÃ¨te du candidat choisi"""
        print("ğŸ¯ TRANSFORMATION CANDIDAT CHOISI - AGENT 11 AUDITEUR QUALITÃ‰")
        print("=" * 70)
        print(f"ğŸ“ Candidat: {CANDIDAT_CHOISI}")
        print(f"ğŸ¯ RÃ©pertoire: {AGENTS_DIR}")
        print(f"ğŸ’¾ Backups: {BACKUPS_DIR}")
        print("ğŸ›¡ï¸ TOUTES LES SÃ‰CURITÃ‰S ACTIVÃ‰ES")
        print("=" * 70)
        
        try:
            # 1. VÃ©rifications prÃ©liminaires
            print("\nğŸ” PHASE 1: VÃ‰RIFICATIONS PRÃ‰LIMINAIRES")
            agent_path = AGENTS_DIR / CANDIDAT_CHOISI
            
            if not agent_path.exists():
                raise Exception(f"âŒ Agent non trouvÃ©: {agent_path}")
            
            print(f"âœ… Agent trouvÃ©: {agent_path}")
            print(f"ğŸ“ Taille: {agent_path.stat().st_size:,} caractÃ¨res")
            
            # VÃ©rifier rÃ©pertoires de sÃ©curitÃ©
            BACKUPS_DIR.mkdir(exist_ok=True)
            REPORTS_DIR.mkdir(exist_ok=True)
            print(f"âœ… RÃ©pertoires de sÃ©curitÃ© vÃ©rifiÃ©s")
            
            # 2. Initialiser Agent 03 Upgraded
            print("\nğŸš€ PHASE 2: INITIALISATION AGENT 03 UPGRADED")
            agent03 = await self.initialiser_agent03_upgraded()
            
            # 3. Analyse prÃ©-transformation
            print("\nğŸ” PHASE 3: ANALYSE PRÃ‰-TRANSFORMATION")
            analyse_pre = await self.analyser_pre_transformation(agent03, agent_path)
            
            # 4. Confirmation utilisateur
            print("\nâš ï¸ PHASE 4: CONFIRMATION TRANSFORMATION")
            self.afficher_resume_transformation(analyse_pre)
            
            confirmation = input("\nğŸ¯ Confirmer la transformation ? (oui/non): ").lower().strip()
            if confirmation not in ['oui', 'o', 'yes', 'y']:
                print("âŒ Transformation annulÃ©e par l'utilisateur")
                return False
            
            # 5. Transformation avec sÃ©curitÃ©s maximales
            print("\nğŸ”§ PHASE 5: TRANSFORMATION AVEC SÃ‰CURITÃ‰S MAXIMALES")
            resultat_transformation = await agent03.transform_single_agent(agent_path, force_backup=True)
            
            # 6. Validation post-transformation
            print("\nâœ… PHASE 6: VALIDATION POST-TRANSFORMATION")
            validation = await self.valider_post_transformation(agent03, agent_path, resultat_transformation)
            
            # 7. Rapport final
            print("\nğŸ“Š PHASE 7: GÃ‰NÃ‰RATION RAPPORT FINAL")
            rapport_final = await self.generer_rapport_final(resultat_transformation, validation)
            
            # 8. ArrÃªt propre
            await agent03.shutdown()
            
            return rapport_final
            
        except Exception as e:
            self.logger.error(f"âŒ Erreur transformation: {e}")
            print(f"\nğŸ’¥ ERREUR FATALE: {e}")
            return False

    async def initialiser_agent03_upgraded(self):
        """Initialise l'Agent 03 Upgraded"""
        try:
            sys.path.append("agent_equipe_maintenance")
            from agent_MAINTENANCE_03_adaptateur_code_UPGRADED import AdaptateurCodeUpgraded
            
            agent03 = AdaptateurCodeUpgraded()
            await agent03.startup()
            
            print(f"âœ… Agent 03 Upgraded initialisÃ©: {agent03.agent_id}")
            print(f"ğŸ“‹ CapacitÃ©s: {len(agent03.get_capabilities())}")
            
            return agent03
            
        except Exception as e:
            raise Exception(f"Erreur initialisation Agent 03: {e}")

    async def analyser_pre_transformation(self, agent03, agent_path):
        """Analyse prÃ©-transformation dÃ©taillÃ©e"""
        try:
            # Lire le fichier
            with open(agent_path, 'r', encoding='utf-8') as f:
                contenu = f.read()
            
            # Analyser structure
            structure = agent03._analyze_current_structure(contenu)
            
            # DÃ©tecter problÃ¨mes
            problemes = []
            if "async async def" in contenu:
                problemes.append("Erreur syntaxe 'async async def'")
            if not structure.get('import_pattern_factory', False):
                problemes.append("Import Pattern Factory manquant")
            if not structure.get('inherits_from_agent', False):
                problemes.append("N'hÃ©rite pas de la classe Agent")
            
            analyse = {
                "fichier": agent_path.name,
                "taille": len(contenu),
                "lignes": len(contenu.splitlines()),
                "structure": structure,
                "problemes_detectes": problemes,
                "score_conformite": self.calculer_score_conformite(structure),
                "timestamp": datetime.now().isoformat()
            }
            
            print(f"ğŸ“Š ProblÃ¨mes dÃ©tectÃ©s: {len(problemes)}")
            for probleme in problemes:
                print(f"   ğŸš¨ {probleme}")
            
            print(f"ğŸ“ˆ Score conformitÃ©: {analyse['score_conformite']:.1f}%")
            
            return analyse
            
        except Exception as e:
            raise Exception(f"Erreur analyse prÃ©-transformation: {e}")

    def calculer_score_conformite(self, structure):
        """Calcule le score de conformitÃ© Pattern Factory"""
        criteres = [
            structure.get('has_main_class', False),
            structure.get('inherits_from_agent', False),
            structure.get('has_startup_method', False),
            structure.get('has_shutdown_method', False),
            structure.get('has_health_check_method', False),
            structure.get('has_execute_task_method', False),
            structure.get('import_pattern_factory', False)
        ]
        
        return (sum(criteres) / len(criteres)) * 100

    def afficher_resume_transformation(self, analyse):
        """Affiche le rÃ©sumÃ© avant transformation"""
        print("\n" + "="*50)
        print("ğŸ“‹ RÃ‰SUMÃ‰ TRANSFORMATION")
        print("="*50)
        print(f"ğŸ“ Fichier: {analyse['fichier']}")
        print(f"ğŸ“ Taille: {analyse['taille']:,} caractÃ¨res")
        print(f"ğŸ“„ Lignes: {analyse['lignes']:,}")
        print(f"ğŸ“Š Score conformitÃ© actuel: {analyse['score_conformite']:.1f}%")
        print(f"ğŸš¨ ProblÃ¨mes Ã  corriger: {len(analyse['problemes_detectes'])}")
        
        for i, probleme in enumerate(analyse['problemes_detectes'], 1):
            print(f"   {i}. {probleme}")
        
        print("\nğŸ›¡ï¸ SÃ‰CURITÃ‰S ACTIVÃ‰ES:")
        print("   âœ… Backup automatique obligatoire")
        print("   âœ… Validation AST Python")
        print("   âœ… Rollback automatique en cas d'erreur")
        print("   âœ… Logging complet des opÃ©rations")
        print("   âœ… Rapport de transformation dÃ©taillÃ©")

    async def valider_post_transformation(self, agent03, agent_path, resultat_transformation):
        """Validation post-transformation"""
        try:
            print("ğŸ” Validation du rÃ©sultat de transformation...")
            
            # Lire le fichier transformÃ©
            with open(agent_path, 'r', encoding='utf-8') as f:
                contenu_transforme = f.read()
            
            # Analyser nouvelle structure
            nouvelle_structure = agent03._analyze_current_structure(contenu_transforme)
            nouveau_score = self.calculer_score_conformite(nouvelle_structure)
            
            # VÃ©rifier syntaxe Python
            try:
                compile(contenu_transforme, str(agent_path), 'exec')
                syntaxe_valide = True
            except SyntaxError as e:
                syntaxe_valide = False
                print(f"âš ï¸ Erreur syntaxe dÃ©tectÃ©e: {e}")
            
            validation = {
                "transformation_reussie": resultat_transformation.get("success", False),
                "nouveau_score_conformite": nouveau_score,
                "syntaxe_python_valide": syntaxe_valide,
                "backups_crees": resultat_transformation.get("backup_path") is not None,
                "corrections_appliquees": resultat_transformation.get("corrections_applied", 0),
                "timestamp": datetime.now().isoformat()
            }
            
            print(f"âœ… Transformation rÃ©ussie: {validation['transformation_reussie']}")
            print(f"ğŸ“ˆ Nouveau score: {validation['nouveau_score_conformite']:.1f}%")
            print(f"ğŸ Syntaxe Python: {'âœ… Valide' if validation['syntaxe_python_valide'] else 'âŒ Erreur'}")
            print(f"ğŸ’¾ Backups crÃ©Ã©s: {'âœ… Oui' if validation['backups_crees'] else 'âŒ Non'}")
            print(f"ğŸ”§ Corrections: {validation['corrections_appliquees']}")
            
            return validation
            
        except Exception as e:
            print(f"âŒ Erreur validation: {e}")
            return {"erreur": str(e)}

    async def generer_rapport_final(self, resultat_transformation, validation):
        """GÃ©nÃ¨re le rapport final de transformation"""
        rapport = {
            "mission_id": f"transformation_candidat_1_{datetime.now().strftime('%Y%m%d_%H%M%S')}",
            "candidat_choisi": CANDIDAT_CHOISI,
            "timestamp_debut": datetime.now().isoformat(),
            "resultat_transformation": resultat_transformation,
            "validation_post_transformation": validation,
            "statut_final": "SUCCÃˆS" if validation.get("transformation_reussie", False) else "Ã‰CHEC",
            "recommandations": []
        }
        
        # GÃ©nÃ©rer recommandations
        if validation.get("transformation_reussie", False):
            rapport["recommandations"].append("âœ… Transformation rÃ©ussie - Agent conforme Pattern Factory")
            if validation.get("nouveau_score_conformite", 0) >= 90:
                rapport["recommandations"].append("ğŸ¯ Score excellent - PrÃªt pour production")
            else:
                rapport["recommandations"].append("âš ï¸ Score moyen - VÃ©rifications supplÃ©mentaires recommandÃ©es")
        else:
            rapport["recommandations"].append("âŒ Transformation Ã©chouÃ©e - VÃ©rifier les logs")
            rapport["recommandations"].append("ğŸ”„ Rollback automatique effectuÃ© si nÃ©cessaire")
        
        # Sauvegarder rapport
        rapport_file = REPORTS_DIR / f"transformation_candidat_1_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        import json
        with open(rapport_file, 'w', encoding='utf-8') as f:
            json.dump(rapport, f, indent=2, ensure_ascii=False)
        
        print(f"ğŸ“Š Rapport final sauvÃ©: {rapport_file.name}")
        
        # Afficher rÃ©sumÃ© final
        self.afficher_resume_final(rapport)
        
        return rapport

    def afficher_resume_final(self, rapport):
        """Affiche le rÃ©sumÃ© final"""
        print("\n" + "="*70)
        print("ğŸ‰ RÃ‰SUMÃ‰ FINAL TRANSFORMATION")
        print("="*70)
        print(f"ğŸ“ Agent transformÃ©: {rapport['candidat_choisi']}")
        print(f"ğŸ“Š Statut final: {rapport['statut_final']}")
        
        validation = rapport.get('validation_post_transformation', {})
        if validation:
            print(f"ğŸ“ˆ Score final: {validation.get('nouveau_score_conformite', 0):.1f}%")
            print(f"ğŸ”§ Corrections appliquÃ©es: {validation.get('corrections_appliquees', 0)}")
            print(f"ğŸ’¾ SÃ©curitÃ© backup: {'âœ…' if validation.get('backups_crees') else 'âŒ'}")
        
        print("\nğŸ“‹ Recommandations:")
        for rec in rapport.get('recommandations', []):
            print(f"   {rec}")

async def main():
    """Point d'entrÃ©e principal"""
    try:
        transformation = TransformationCandidatChoisi()
        resultat = await transformation.lancer_transformation_complete()
        
        return 0 if resultat else 1
        
    except Exception as e:
        print(f"ğŸ’¥ Erreur fatale: {e}")
        return 1

if __name__ == "__main__":
    sys.exit(asyncio.run(main())) 